name: Capitalization Suggestions

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "suggest | apply"
        required: true
        default: "suggest"
      input_jsonl:
        description: "Path to input JSONL"
        required: true
        default: "output_phase3/psalms.jsonl"
      suggestions_csv:
        description: "Where to write suggestions CSV"
        required: true
        default: "reviews/capitalization_suggestions.csv"
      review_csv:
        description: "Reviewed CSV (decision=APPROVE/REJECT)"
        required: false
        default: "reviews/capitalization_suggestions.review.csv"
      output_jsonl:
        description: "Where to write updated JSONL (apply mode)"
        required: false
        default: "data/psalms.updated.jsonl"

jobs:
  caps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create output directories
        run: |
          mkdir -p reviews data

      - name: Generate suggestions CSV
        if: ${{ inputs.mode == 'suggest' }}
        run: |
          python scripts/suggest_caps.py "${{ inputs.input_jsonl }}" "${{ inputs.suggestions_csv }}"
          ls -lah reviews

      - name: Upload suggestions artifact
        if: ${{ inputs.mode == 'suggest' }}
        uses: actions/upload-artifact@v4
        with:
          name: capitalization-suggestions
          path: ${{ inputs.suggestions_csv }}

      - name: Convert reviewed CSV to UTF-8 (Python)
        if: ${{ inputs.mode == 'apply' }}
        run: |
          python - <<'PY'
          from pathlib import Path

          inp = Path("${{ inputs.review_csv }}")
          out = Path("${{ inputs.review_csv }}.utf8")

          if not inp.exists():
              raise SystemExit(f"ERROR: Reviewed CSV not found: {inp}")

          b = inp.read_bytes()

          # Try common Excel encodings (stop at first that works)
          s = None
          used = None
          for enc in ("utf-8-sig", "utf-8", "cp1252", "latin-1", "utf-16", "utf-16le", "utf-16be"):
              try:
                  s = b.decode(enc)
                  used = enc
                  break
              except UnicodeDecodeError:
                  pass

          if s is None:
              # Last resort: replace undecodable bytes (tripwire below will catch this)
              used = "utf-8(errors=replace)"
              s = b.decode("utf-8", errors="replace")

          # Normalize smart quotes
          s = (s.replace("“", '"').replace("”", '"')
                 .replace("‘", "'").replace("’", "'"))

          out.write_text(s, encoding="utf-8")
          print(f"Wrote UTF-8 reviewed CSV: {out} (decoded as {used})")

          # Tripwire: fail if replacement characters appear
          if "�" in s:
              raise SystemExit("ERROR: Replacement character (�) found after conversion. Re-export CSV as UTF-8 or edit in VS Code.")
          PY

      - name: Apply approved changes
        if: ${{ inputs.mode == 'apply' }}
        run: |
          python scripts/apply_caps.py \
            "${{ inputs.input_jsonl }}" \
            "${{ inputs.review_csv }}.utf8" \
            "${{ inputs.output_jsonl }}"
          ls -lah data

      - name: Upload updated JSONL artifact
        if: ${{ inputs.mode == 'apply' }}
        uses: actions/upload-artifact@v4
        with:
          name: psalms-updated
          path: ${{ inputs.output_jsonl }}
